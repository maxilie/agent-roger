import { env, type RedisManager } from "agent-roger-core";

// settings
const modelPath = "/Users/maxilie/Desktop/dolphin-2.6-mixtral-8x7b.Q3_K_M.gguf"
const testSystemMsg = `You are a helpful assistant who can answer any question succinctly but thoroughly and expertly`

const testUserMsg1 = `Summarize the following passage: To explore the history of the universe, we will follow the same path that astronomers followed historically—beginning with studies of the nearby universe and then probing ever-more-distant objects and looking further back in time.The realization that the universe changes with time came in the 1920s and 1930s when measurements of the redshifts of a large sample of galaxies became available. With hindsight, it is surprising that scientists were so shocked to discover that the universe is expanding. In fact, our theories of gravity demand that the universe must be either expanding or contracting. To show what we mean, let’s begin with a universe of finite size—say a giant ball of a thousand galaxies. All these galaxies attract each other because of their gravity. If they were initially stationary, they would inevitably begin to move closer together and eventually collide. They could avoid this collapse only if for some reason they happened to be moving away from each other at high speeds. In just the same way, only if a rocket is launched at high enough speed can it avoid falling back to Earth.The problem of what happens in an infinite universe is harder to solve`
const testUserMsg = `Summarize the following passage: To explore the history of the universe, we will follow the same path that astronomers followed historically—beginning with studies of the nearby universe and then probing ever-more-distant objects and looking further back in time.The realization that the universe changes with time came in the 1920s and 1930s when measurements of the redshifts of a large sample of galaxies became available. With hindsight, it is surprising that scientists were so shocked to discover that the universe is expanding. In fact, our theories of gravity demand that the universe must be either expanding or contracting. To show what we mean, let’s begin with a universe of finite size—say a giant ball of a thousand galaxies. All these galaxies attract each other because of their gravity. If they were initially stationary, they would inevitably begin to move closer together and eventually collide. They could avoid this collapse only if for some reason they happened to be moving away from each other at high speeds. In just the same way, only if a rocket is launched at high enough speed can it avoid falling back to Earth.The problem of what happens in an infinite universe is harder to solve, but Einstein (and others) used his theory of general relativity (which we described in Black Holes and Curved Spacetime) to show that even infinite universes cannot be static. Since astronomers at that time did not yet know the universe was expanding (and Einstein himself was philosophically unwilling to accept a universe in motion), he changed his equations by introducing an arbitrary new term (we might call it a fudge factor) called the cosmological constant. This constant represented a hypothetical force of repulsion that could balance gravitational attraction on the largest scales and permit galaxies to remain at fixed distances from one another. That way, the universe could remain still.Figure 29.2 Einstein and Hubble. (a) Albert Einstein is shown in a 1921 photograph. (b) Edwin Hubble at work in the Mt. Wilson Observatory.About a decade later, Hubble, and his coworkers reported that the universe is expanding, so that no mysterious balancing force is needed. (We discussed this in the chapter on Galaxies.) Einstein is reported to have said that the introduction of the cosmological constant was ‘the biggest blunder of my life.’ As we shall see later in this chapter, however, relatively recent observations indicate that the expansion is accelerating. Observations are now being carried out to determine whether this acceleration is consistent with a cosmological constant. In a way, it may turn out that Einstein was right after all.LINK TO LEARNING\nView this web exhibit on the history of our thinking about cosmology, with images and biographies, from the American Institute of Physics Center for the History of Physics.\nThe Hubble Time\nIf we had a movie of the expanding universe and ran the film backward, what would we see? The galaxies, instead of moving apart, would move together in our movie—getting closer and closer all the time. Eventually, we would find that all the matter we can see today was once concentrated in an infinitesimally small volume. Astronomers identify this time with the beginning of the universe. The explosion of that concentrated universe at the beginning of time is called the Big Bang (not a bad term, since you can’t have a bigger bang than one that creates the entire universe). But when did this bang occur?\nWe can make a reasonable estimate of the time since the universal expansion began. To see how astronomers do this, let’s begin with an analogy. Suppose your astronomy class decides to have a party (a kind of ‘Big Bang’) at someone’s home to celebrate the end of the semester. Unfortunately, everyone is celebrating with so much enthusiasm that the neighbors call the police, who arrive and send everyone away at the same moment. You get home at 2 a.m., still somewhat upset about the way the party ended, and realize you forgot to look at your watch to see what time the police got there. But you use a map to measure that the distance between the party and your house is 40 kilometers. And you also remember that you drove the whole trip at a steady speed of 80 kilometers/hour (since you were worried about the police cars following you). Therefore, the trip must have taken:\ntime=distancevelocity=40kilometers80kilometers/hour=0.5hourstime=distancevelocity=40kilometers80kilometers/hour=0.5hours\nSo the party must have broken up at 1:30 a.m.\nNo humans were around to look at their watches when the universe began, but we can use the same technique to estimate when the galaxies began moving away from each other. (Remember that, in reality, it is space that is expanding, not the galaxies that are moving through static space.) If we can measure how far apart the galaxies are now, and how fast they are moving, we can figure out how long a trip it’s been.\nLet’s call the age of the universe measured in this way T0. Let’s first do a simple case by assuming that the expansion has been at a constant rate ever since the expansion of the universe began. In this case, the time it has taken a galaxy to move a distance, d, away from the Milky Way (remember that at the beginning the galaxies were all together in a very tiny volume) is (as in our example)\n𝑇0=𝑑/𝑣�0=�/�\nwhere v is the velocity of the galaxy. If we can measure the speed with which galaxies are moving away, and also the distances between them, we can establish how long ago the expansion began.\nMaking such measurements should sound very familiar. This is just what Hubble and many astronomers after him needed to do in order to establish the Hubble law and the Hubble constant. We learned in Galaxies that a galaxy’s distance and its velocity in the expanding universe are related by\n𝑉=𝐻×𝑑�=�×�\nwhere H is the Hubble constant. Combining these two expressions gives us\n𝑇0=𝑑𝑣=𝑑(𝐻×𝑑)=1𝐻�0=��=�(�×�)=1�\nWe see, then, that the work of calculating this time was already done for us when astronomers measured the Hubble constant. The age of the universe estimated in this way turns out to be just the reciprocal of the Hubble constant (that is, 1/H). This age estimate is sometimes called the Hubble time. For a Hubble constant of 20 kilometers/second per million light-years, the Hubble time is about 15 billion years. (By the way, the unit used by astronomers for the Hubble constant is kilometers/second per million parsecs. In these units, the Hubble constant is equal to about 70 kilometers/second per million parsecs, again with an uncertainty of about 5%.)\nTo make numbers easier to remember, we have done some rounding here. Estimates for the Hubble constant are actually closer to 21 or 22 kilometers/second per million light-years, which would make the age closer to 14 billion years. But there is still about a 5% uncertainty in the Hubble constant, which means the age of the universe estimated in this way is also uncertain by about 5%.\nTo put these uncertainties in perspective, however, you should know that 50 years ago, the uncertainty was a factor of 2. Remarkable progress toward pinning down the Hubble constant has been made in the last couple of decades.\n\nThe Role of Deceleration\nThe Hubble time is the right age for the universe only if the expansion rate has been constant throughout the time since the expansion of the universe began. Continuing with our end-of-the-semester-party analogy, this is equivalent to assuming that you traveled home from the party at a constant rate, when in fact this may not have been the case. At first, mad about having to leave, you may have driven fast, but then as you calmed down—and thought about police cars on the highway—you may have begun to slow down until you were driving at a more socially acceptable speed (such as 80 kilometers/hour). In this case, given that you were driving faster at the beginning, the trip home would have taken less than a half-hour.\nIn the same way, in calculating the Hubble time, we have assumed that the expansion rate has been constant throughout all of time. It turns out that this is not a good assumption. Earlier in their thinking about this, astronomers expected that the rate of expansion should be slowing down. We know that matter creates gravity, whereby all objects pull on all other objects. The mutual attraction between galaxies was expected to slow the expansion as time passed. This means that, if gravity were the only force acting (a big if, as we shall see in the next section), then the rate of expansion must have been faster in the past than it is today. In this case, we would say the universe has been decelerating since the beginning.\nHow much it has decelerated depends on the importance of gravity in slowing the expansion. If the universe were nearly empty, the role of gravity would be minor. Then the deceleration would be close to zero, and the universe would have been expanding at a constant rate. But in a universe with any significant density of matter, the pull of gravity means that the rate of expansion should be slower now than it used to be. If we use the current rate of expansion to estimate how long it took the galaxies to reach their current separations, we will overestimate the age of the universe—just as we may have overestimated the time it took for you to get home from the party.\nA Universal Acceleration\nAstronomers spent several decades looking for evidence that the expansion was decelerating, but they were not successful. What they needed were 1) larger telescopes so that they could measure the redshifts of more distant galaxies and 2) a very luminous standard bulb (or standard candle), that is, some astronomical object with known luminosity that produces an enormous amount of energy and can be observed at distances of a billion light-years or more.\nRecall that we discussed standard bulbs in the chapter on Galaxies. If we compare how luminous a standard bulb is supposed to be and how dim it actually looks in our telescopes, the difference allows us to calculate its distance. The redshift of the galaxy such a bulb is in can tell us how fast it is moving in the universe. So we can measure its distance and motion independently.\nThese two requirements were finally met in the 1990s. Astronomers showed that supernovae of type Ia (see The Death of Stars), with some corrections based on the shapes of their light curves, are standard bulbs. This type of supernova occurs when a white dwarf accretes enough material from a companion star to exceed the Chandrasekhar limit and then collapses and explodes. At the time of maximum brightness, these dramatic supernovae can briefly outshine the galaxies that host them, and hence, they can be observed at very large distances. Large 8- to 10-meter telescopes can be used to obtain the spectra needed to measure the redshifts of the host galaxies (Figure 29.3).\nFigure 29.3 Five Supernovae and Their Host Galaxies. The top row shows each galaxy and its supernova (arrow). The bottom row shows the same galaxies either before or after the supernovae exploded. (credit: modification of work by NASA, ESA, and A. Riess (STScI))\nThe result of painstaking, careful study of these supernovae in a range of galaxies, carried out by two groups of researchers, was published in 1998. It was shocking—and so revolutionary that their discovery received the 2011 Nobel Prize in Physics. What the researchers found was that these type Ia supernovae in distant galaxies were fainter than expected from Hubble’s law, given the measured redshifts of their host galaxies. In other words, distances estimated from the supernovae used as standard bulbs disagreed with the distances measured from the redshifts.\nIf the universe were decelerating, we would expect the far-away supernovae to be brighter than expected. The slowing down would have kept them closer to us. Instead, they were fainter, which at first seemed to make no sense.\nBefore accepting this shocking development, astronomers first explored the possibility that the supernovae might not really be as useful as standard bulbs as they thought. Perhaps the supernovae appeared too faint because dust along our line of sight to them absorbed some of their light. Or perhaps the supernovae at large distances were for some reason intrinsically less luminous than nearby supernovae of type Ia.\nA host of more detailed observations ruled out these possibilities. Scientists then had to consider the alternative that the distance estimated from the redshift was incorrect. Distances derived from redshifts assume that the Hubble constant has been truly constant for all time. We saw that one way it might not be constant is that the expansion is slowing down. But suppose neither assumption is right (steady speed or slowing down.)\nSuppose, instead, that the universe is accelerating. If the universe is expanding faster now than it was billions of years ago, our motion away from the distant supernovae has sped up since the explosion occurred, sweeping us farther away from them. The light of the explosion has to travel a greater distance to reach us than if the expansion rate were constant. The farther the light travels, the fainter it appears. This conclusion would explain the supernova observations in a natural way, and this has now been substantiated by many additional observations over the last couple of decades. It really seems that the expansion of the universe is accelerating, a notion so unexpected that astronomers at first resisted considering it.\nHow can the expansion of the universe be speeding up? If you want to accelerate your car, you must supply energy by stepping on the gas. Similarly, energy must be supplied to accelerate the expansion of the universe. The discovery of the acceleration was shocking because scientists still have no idea what the source of the energy is. Scientists call whatever it is dark energy, which is a clear sign of how little we understand it.\nNote that this new component of the universe is not the dark matter we talked about in earlier chapters. Dark energy is something else that we have also not yet detected in our laboratories on Earth.\nWhat is dark energy? One possibility is that it is the cosmological constant, which is an energy associated with the vacuum of ‘empty’ space itself. Quantum mechanics (the intriguing theory of how things behave at the atomic and subatomic levels) tells us that the source of this vacuum energy might be tiny elementary particles that flicker in and out of existence everywhere throughout the universe. Various attempts have been made to calculate how big the effects of this vacuum energy should be, but so far these attempts have been unsuccessful. In fact, the order of magnitude of theoretical estimates of the vacuum energy based on the quantum mechanics of matter and the value required to account for the acceleration of the expansion of the universe differ by an incredible factor of at least 10120 (that is a 1 followed by 120 zeros)! Various other theories have been suggested, but the bottom line is that, although there is compelling evidence that dark energy exists, we do not yet know the source of that energy.\nWhatever the dark energy turns out to be, we should note that the discovery that the rate of expansion has not been constant since the beginning of the universe complicates the calculation of the age of the universe. Interestingly, the acceleration seems not to have started with the Big Bang. During the first several billion years after the Big Bang, when galaxies were close together, gravity was strong enough to slow the expansion. As galaxies moved farther apart, the effect of gravity weakened. Several billion years after the Big Bang, dark energy took over, and the expansion began to accelerate (Figure 29.4).\nFigure 29.4 Changes in the Rate of Expansion of the Universe Since Its Beginning 13.8 Billion Years Ago. The more the diagram spreads out horizontally, the faster the change in the velocity of expansion. After a period of very rapid expansion at the beginning, which scientists call inflation and which we will discuss later in this chapter, the expansion began to decelerate. Galaxies were then close together, and their mutual gravitational attraction slowed the expansion. After a few billion years, when galaxies were farther apart, the influence of gravity began to weaken. Dark energy then took over and caused the expansion to accelerate. (credit: modification of work by Ann Feild (STScI))\nDeceleration works to make the age of the universe estimated by the simple relation 𝑇0=1/𝐻�0=1/� seem older than it really is, whereas acceleration works to make it seem younger. By happy coincidence, our best estimates of how much deceleration and acceleration occurred lead to an answer for the age very close to 𝑇0=1/𝐻�0=1/�. The best current estimate is that the universe is 13.8 billion years old with an uncertainty of only about 100 million years.\nThroughout this chapter, we have referred to the Hubble constant. We now know that the Hubble constant does change with time. It is, however, constant everywhere in the universe at any given time. When we say the Hubble constant is about 70 kilometers/second/million parsecs, we mean that this is the value of the Hubble constant at the current time.\n\nComparing Ages\nWe now have one estimate for the age of the universe from its expansion. Is this estimate consistent with other observations? For example, are the oldest stars or other astronomical objects younger than 13.8 billion years? After all, the universe has to be at least as old as the oldest objects in it.\nIn our Galaxy and others, the oldest stars are found in the globular clusters (Figure 29.5), which can be dated using the models of stellar evolution described in the chapter Stars from Adolescence to Old Age.\nFigure 29.5 Globular Cluster 47 Tucanae. This NASA/ESA Hubble Space Telescope image shows a globular cluster known as 47 Tucanae, since it is in the constellation of Tucana (The Toucan) in the southern sky. The second-brightest globular cluster in the night sky, it includes hundreds of thousands of stars. Globular clusters are among the oldest objects in our Galaxy and can be used to estimate its age. (credit: NASA, ESA, and the Hubble Heritage (STScI/AURA)-ESA/Hubble Collaboration)\nThe accuracy of the age estimates of the globular clusters has improved markedly in recent years for two reasons. First, models of interiors of globular cluster stars have been improved, mainly through better information about how atoms absorb radiation as they make their way from the center of a star out into space. Second, observations from satellites have improved the accuracy of our measurements of the distances to these clusters. The conclusion is that the oldest stars formed about 12–13 billion years ago.\nThis age estimate has recently been confirmed by the study of the spectrum of uranium in the stars. The isotope uranium-238 is radioactive and decays (changes into another element) over time. (Uranium-238 gets its designation because it has 92 protons and 146 neutrons.) We know (from how stars and supernovae make elements) how much uranium-238 is generally made compared to other elements. Suppose we measure the amount of uranium relative to nonradioactive elements in a very old star and in our own Sun, and compare the abundances. With those pieces of information, we can estimate how much longer the uranium has been decaying in the very old star because we know from our own Sun how much uranium decays in 4.5 billion years.\nThe line of uranium is very weak and hard to make out even in the Sun, but it has now been measured in one extremely old star using the European Very Large Telescope (Figure 29.6). Comparing the abundance with that in the solar system, whose age we know, astronomers estimate the star is 12.5 billion years old, with an uncertainty of about 3 billion years. While the uncertainty is large, this work is important confirmation of the ages estimated by studies of the globular cluster stars. Note that the uranium age estimate is completely independent; it does not depend on either the measurement of distances or on models of the interiors of stars.\nFigure 29.6 European Extremely Large Telescope, European Very Large Telescope, and the Colosseum. The European Extremely Large Telescope (E-ELT) is currently under construction in Chile. This image compares the size of the E-ELT (left) with the four 8-meter telescopes of the European Very Large Telescope (center) and with the Colosseum in Rome (right). The mirror of the E-ELT will be 39 meters in diameter. Astronomers are building a new generation of giant telescopes in order to observe very distant galaxies and understand what they were like when they were newly formed and the universe was young. (credit: modification of work by ESO)\nAs we shall see later in this chapter, the globular cluster stars probably did not form until the expansion of the universe had been underway for at least a few hundred million years. Accordingly, their ages are consistent with the 13.8 billion-year age estimated from the expansion rate.\nThe description of the first few minutes of the universe is based on theoretical calculations. It is crucial, however, that a scientific theory should be testable. What predictions does it make? And do observations show those predictions to be accurate? One success of the theory of the first few minutes of the universe is the correct prediction of the amount of helium in the universe.\nAnother prediction is that a significant milestone in the history of the universe occurred about 380,000 years after the Big Bang. Scientists have directly observed what the universe was like at this early stage, and these observations offer some of the strongest support for the Big Bang theory. To find out what this milestone was, let’s look at what theory tells us about what happened during the first few hundred thousand years after the Big Bang.\nThe fusion of helium and lithium was completed when the universe was about 4 minutes old. The universe then continued to resemble the interior of a star in some ways for a few hundred thousand years more. It remained hot and opaque, with radiation being scattered from one particle to another. It was still too hot for electrons to ‘settle down’ and become associated with a particular nucleus; such free electrons are especially effective at scattering photons, thus ensuring that no radiation ever got very far in the early universe without having its path changed. In a way, the universe was like an enormous crowd right after a popular concert; if you get separated from a friend, even if he is wearing a flashing button, it is impossible to see through the dense crowd to spot him. Only after the crowd clears is there a path for the light from his button to reach you.\n\nThe Universe Becomes Transparent\nNot until a few hundred thousand years after the Big Bang, when the temperature had dropped to about 3000 K and the density of atomic nuclei to about 1000 per cubic centimeter, did the electrons and nuclei manage to combine to form stable atoms of hydrogen and helium (Figure 29.14). With no free electrons to scatter photons, the universe became transparent for the first time in cosmic history. From this point on, matter and radiation interacted much less frequently; we say that they decoupled from each other and evolved separately. Suddenly, electromagnetic radiation could really travel, and it has been traveling through the universe ever since.\n\nDiscovery of the Cosmic Background Radiation\nIf the model of the universe described in the previous section is correct, then—as we look far outward in the universe and thus far back in time—the first ‘afterglow’ of the hot, early universe should still be detectable. Observations of it would be very strong evidence that our theoretical calculations about how the universe evolved are correct. As we shall see, we have indeed detected the radiation emitted at this photon decoupling time, when radiation began to stream freely through the universe without interacting with matter (Figure 29.15).\nFigure 29.15 `
const testInput = `<|im_start|>system\n${testSystemMsg}<|im_end|>\n<|im_start|>user\n${testUserMsg}<|im_end|>\n<|im_start|>assistant\n`
const contextSize = 12000;

// globals
let redis: RedisManager;
const SHUTTING_DOWN = false;
let FULLY_INITIALIZED = false;


/**
 * Tests redis connection and AI backend.
 */
const initialize = async () => {
    FULLY_INITIALIZED = false;
    
  
    // connect to redis & init pipeline
    // TODO redis = new RedisManager();
    // TODO await redis.redis.ping();
    console.log("connected to redis");

    // load AI model
    console.log("testing AI model...")
    const startTime = Date.now();
    const inputTokensLen = 5000;
    const response = await fetch("http://127.0.0.1:8080/completion", {
        method: 'POST',
        body: JSON.stringify({
            prompt: testInput,
            n_predict: env.LOCAL_LLM_CONTEXT - inputTokensLen,
            stop: ["<|im_end|>"],
        })
    })
    if (!response.ok || response.status != 200) {
        throw new Error(`failed to test AI model: ${response.status} ${response.statusText}`);
    }
    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
    const respJson = await response.json() as { content: string };
    console.log("response:")
    console.log(respJson.content)
    const timeElapsed = (Date.now() - startTime) / 1000.0;
  console.log(`got a response from AI model in ${timeElapsed} seconds`);
  
    await new Promise((resolve) => setTimeout(resolve, 1000));
    FULLY_INITIALIZED = true;
  };

const runNextPipeline = async () => {
    await new Promise((resolve) => setTimeout(resolve, 1000));
    console.log("\n\n\n")
    console.log("running next inference");
    const startTime = Date.now();
    
    const timeElapsed = (Date.now() - startTime) / 1000;
    await new Promise((resolve) => setTimeout(resolve, 20000));
}


const main = () => {
    console.log("Running main...");
  
    // initialize connections
    initialize()
      .then(async () => {
        // run task pipeline logic
        while (true) {
          if (SHUTTING_DOWN) return;
          
  
          // run the next redis pipeline
          try {
            if (SHUTTING_DOWN) return;
            await runNextPipeline();
          } catch (error) {
            console.error("Error listening to redis queue: ");
            console.error(error);
            if (SHUTTING_DOWN) return;
            console.log("");
            console.log("");
            console.log("");
            console.log("Restarting in 5 seconds...");
            setTimeout(main, 5000);
            break;
          }
        }
      })
      .catch((error) => {
        console.error("Error initializing the inference engine: ", error);
        console.log("Restarting in 5 seconds...");
        if (SHUTTING_DOWN) return;
        setTimeout(main, 5000);
      });
  };

  // Entrypoint
  main();